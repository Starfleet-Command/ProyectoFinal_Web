<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <title>Character Creation</title>
        <style>
            .logo {
                width: 600px;
                height: 400px;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }

            h1 {
                text-align: center;
            }
        </style>
    </head>

    <body>
        <img src="DnD_logo.jpg" class="logo" alt="Photo of the Dungeons and Dragons logo">

        <h1 class="display-6">Create your character!</h1>

        <br>
        <br>

        <!-- Container class div that encloses the character name input -->
        <div class="container">
            <div class="row"> 
                <div class="col">
                </div>

                <div class="col">
                    <div class="characterName">
                        <label for="exampleFormControlInput1" class="form-label">Enter the character's name:</label>
                        <input type="text" class="form-control" id="exampleFormControlInput1" placeholder="Eren Yaeger" onchange="setName(this.value)">
                    </div>
                </div>

                <div class="col">
                </div>
            </div>
        </div>

        <br>

        <!-- Container class div that encloses the level, class and race selection -->
        <div class="container">
            <div class="row align-items-start">
            <div class="col">
                Select your level
                
                <select id="selectLevel" name="level" class="form-select" aria-label="Default select example" 
                onchange="getLevel(document.getElementById('selectClass').value,this.value)">
                    <option selected>Choose one</option>
                </select>
            </div>

            <div class="col">
                Select your class

                <select id="selectClass" name="class" class="form-select" aria-label="Default select example" 
                onchange="getClassInfo(this.value),getLevel(this.value,document.getElementById('selectLevel').value)">
                    <option selected>Choose one</option>
                </select>
            </div>
            
            <div class="col">
                Select your race:

                <select id="selectRace" name="race" class="form-select" aria-label="Default select example" 
                onchange="getRaceInfo(this.value)">
                    <option selected>Choose one</option>
                </select>
            </div>
            </div>
        </div>

        <br>
        <br>

        <!-- Container class div that encloses information regarding the skills to choose, proficiencies, and racial traits -->
        <div class="container">
            <div class="row align-items-start">
                <div class="col">
                    <!-- <div id="skillChoose" class="shadow-none p-3 mb-5 bg-light rounded">
                    </div> -->
                    <div id="selectSkills" class="shadow-none p-3 mb-5 bg-light rounded" onchange="onSkillSelect(0,this)">
                    </div>
                </div>

                <div class="col">
                    <div id="profs" class="shadow-none p-3 mb-5 bg-light rounded">
                    </div>
                </div>

                <div class="col">
                    <div id="racialTraits" class="shadow-none p-3 mb-5 bg-light rounded">
                    </div>
                </div>
            </div>
        </div>

        <!-- Container class div that encloses information regarding throws and equipment -->
        <div class="container">
            <div class="row align-items-start">
                <div class="col">
                    <div id="throws" class="shadow-none p-3 mb-5 bg-light rounded">
                    </div>
                </div>

                <div class="col">
                    <div id="equipment" class="shadow-none p-3 mb-5 bg-light rounded">
                    </div>
                </div>
            </div>
        </div>

        <!-- Container class div that encloses a single statement regarding the level attributes -->
        <div class="container">
            <div class="row"> 
                <div class="col">
                    <div id="level" class="shadow-sm p-3 mb-5 bg-body rounded">
                        <b>Your class has the following attributes at the chosen level:</b>
                    </div>
                </div>

                <div class="col">
                </div>
            </div>
        </div>

        <!-- Container class div that encloses information regarding the score and ability bonus -->
        <div class="container">
            <div class="row align-items-start">
                <div class="col">
                    <div id="scoreBonus" class="shadow-sm p-3 mb-5 bg-body rounded">
                    </div>
                </div>

                <div class="col">
                    <div id="abilityBonus" class="shadow-sm p-3 mb-5 bg-body rounded">
                    </div>
                </div>
            </div>
        </div>

        <!-- Container class div that encloses information regarding spells -->
        <div class="container">
            <div class="row align-items-start">
                <div class="col">
                    <div id="spells" class="shadow-none p-3 mb-5 bg-light rounded">
                    </div>
                </div>

                <!-- <div class="col">
                    <div id="spellAmount" class="shadow-none p-3 mb-5 bg-light rounded">
                    </div>
                </div> -->

                <div class="col">
                    <div id="selectSpells" class="shadow-none p-3 mb-5 bg-light rounded" onchange="onSpellSelect(this)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Container class div that encloses information regarding feats, class specs, and score selection -->
        <div class="container">
            <div class="row align-items-start">
                <div class="col">
                    <div id="feats" class="shadow-sm p-3 mb-5 bg-body rounded">
                    </div>
                </div>

                <div class="col">
                    <div id="classSpecs" class="shadow-sm p-3 mb-5 bg-body rounded">
                    </div>
                </div>

                <div class="col">
                    <div id="selectScores" class="shadow-sm p-3 mb-5 bg-body rounded" onchange="pointBuy()">
                        <b>Select your Ability Scores! Remaining Points: 27/27</b>
                        
                        <br>
                        <br>

                        Strength
                        <select name="Strength" id="str" >
                        
                        </select>
                        <br>
                        Dexterity
                        <select name="Dexterity" id="dex">
                        
                        </select>
                        <br>
                        Constitution
                        <select name="Constitution" id="con">
                            
                        </select>
                        <br>
                        Intelligence
                        <select name="Intelligence" id="int">
                            
                        </select>
                        <br>
                        Wisdom
                        <select name="Wisdom" id="wis">
                        </select>
                        <br>
                        Charisma
                        <select name="Charisma" id="cha">
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Container class div that encloses a centered button -->
        <div class="container">
            <div class="row align-items-start">
                <div class="col">
                </div>

                <div class="col text-center">
                    <button class="btn btn-primary" type="submit" id="formsubmit" onclick="preSubmit()">Submit!</button>
                </div>

                <div class="col">
                </div>
            </div>
        </div>
    </body>
</html>

<script>
  window.onload = function() {
  getClasses();
  getRaces();
  character.proficiencies = [];
  character.abilityScores = [];
  addLevels();
  pointBuySetup();
  
};
    character = {};
    class_profs = [];
    race_profs = [];
    skills = [];

    function setName(name)
    {
        character.name=name;
    }

    function getClasses() {
        var classes = [];
    return fetch("https://www.dnd5eapi.co/api/classes")
            .then(response => response.json())
            .then(responseJson => {
                for (let index = 0; index < responseJson.results.length; index++) {
                    const element = responseJson.results[index];
                    classes.push(element.index);
                }})
            .then(()=>{
                addToSelect(classes,"selectClass");
                })
            
            .catch(error => {
                console.error(error);
            });
        }

    function addToSelect(data,id)
    {
        var select = document.getElementById(id);
                for (let i = 0; i < data.length; i++) {
                var el = document.createElement("option");
                el.innerHTML = data[i];
                el.value = data[i];
                select.add(el);
                }
    }

    function getRaces()
    {
        var races = [];
    return fetch("https://www.dnd5eapi.co/api/races")
            .then(response => response.json())
            .then(responseJson => {
                for (let index = 0; index < responseJson.results.length; index++) {
                    const element = responseJson.results[index];
                    races.push(element.index);
                }})
            .then(()=>{
                addToSelect(races,"selectRace")
                })
            
            .catch(error => {
                console.error(error);
            });
    }

    function getRaceInfo(userRace){
        if(userRace!="Choose your race")
        {
        return fetch("https://www.dnd5eapi.co/api/races/"+userRace)
            .then(response => response.json())
            .then(responseJson => {
                
                var ability_bonuses = responseJson.ability_bonuses;
                var speed = responseJson.speed;
                var start_profs = responseJson.starting_proficiencies;
                var languages = responseJson.languages;
                var traits = responseJson.traits;

                var bonuses = []
                for (let index = 0; index < ability_bonuses.length; index++) {
                    const name = ability_bonuses[index].ability_score.index;
                    const amount = ability_bonuses[index].bonus;
                    const kvp = {name:amount};
                    bonuses.push(kvp);
                }

                character.race=userRace;
                character.speed= speed;
                character.ability_bonuses = ability_bonuses;
                character.languages = [];
                character.traits = [];
                race_profs = [];
                var racials=document.getElementById("racialTraits");
                racials.innerHTML="<b>Because of your race,</b><br><br>";

                racials.innerHTML+="You have a speed of: "+speed+"ft/turn <br><br>";
                racials.innerHTML+="You know the following languages: <br>";
                for (let index = 0; index < languages.length; index++) {
                    racials.innerHTML+= languages[index].name+"<br>";
                    character.languages.push(languages[index].name);
                }

                racials.innerHTML+="<br> You have the following traits: <br>";
                for (let index = 0; index < traits.length; index++) {
                    racials.innerHTML+= traits[index].name+"<br>";
                    character.traits.push(traits[index].name);
                }

                racials.innerHTML+="<br> You are naturally proficient in the following: <br>";
                for (let index = 0; index < start_profs.length; index++) {
                    racials.innerHTML+= start_profs[index].name+"<br>";
                    race_profs.push(start_profs[index].name);
                }
                })
            
            .catch(error => {
                console.error(error);
            });
    }
    }

    function addLevels()
    {
        levels = [];
        for (let index = 1; index < 21; index++) {
            levels.push(index); 
        }
        addToSelect(levels,"selectLevel");
    }

    function getClassInfo(userClass)
    {
        return fetch("https://www.dnd5eapi.co/api/classes/"+userClass)
            .then(response => response.json())
            .then(responseJson => {
                var prof_amount = responseJson.proficiency_choices[0].choose;
                var skills = responseJson.proficiency_choices[0].from;
                var proficiencies = responseJson.proficiencies;
                var saving_throws = responseJson.saving_throws;
                var starting_equipment = responseJson.starting_equipment;
                var hitdice = responseJson.hit_die;

                character.hp=hitdice;
                character.class=userClass;
                class_profs = [];
                character.saveThrows = [];
                character.equipment = [];
                character.proficiencies.amount = prof_amount;

                // var profText = document.getElementById("skillChoose");
                // profText.innerHTML="<b>You are proficient in up to "+prof_amount+" of the following:<b><br><br>";

                var selectSkills = document.getElementById("selectSkills");
                selectSkills.innerHTML="<b>You are proficient in up to "+prof_amount+" of the following:<b><br><br>";
                

                for (let index = 0; index < skills.length; index++) {
                    var checkbox = document.createElement('input');
                    checkbox.id = "skillCheckbox"+index;
                    checkbox.type = "checkbox";
                    checkbox.value = 1;
                    checkbox.name = skills[index].index;
                    // All the three lines of code below used to start with "selectSkills"
                    selectSkills.appendChild(checkbox);
                    selectSkills.appendChild(document.createTextNode(skills[index].name));
                    selectSkills.innerHTML+="<br>"
                }
                
                var profs = document.getElementById("profs");
                profs.innerHTML="";
                profs.innerHTML += "<b>Because of your class,</b><br><br>You are proficient with the following items: <br>"
                for (let index = 0; index < proficiencies.length; index++) {
                    profs.innerHTML+= proficiencies[index].name + "<br>";
                    class_profs.push(proficiencies[index].name);
                }

                var saves = document.getElementById("throws");
                saves.innerHTML="";
                saves.innerHTML += "<b>You are proficient in the following saving throws: <b><br><br>"

                for (let index = 0; index < saving_throws.length; index++) {
                    saves.innerHTML+= saving_throws[index].name + "<br>";

                    character.saveThrows.push(saving_throws[index].name);
                }

                var equip = document.getElementById("equipment");
                equip.innerHTML="";
                equip.innerHTML += "<b>You start with the following equipment: <b><br><br>"

                for (let index = 0; index < starting_equipment.length; index++) {
                    equip.innerHTML+= starting_equipment[index].equipment.name + "<br>";
                    character.equipment.push(starting_equipment[index].equipment.name);
                }
                
            })
            .catch(error => {
                console.error(error);
            });
    }

     function getLevel(userClass,level) {
        if(userClass!="Choose a class") {
            character.level = level;
        return fetch("https://www.dnd5eapi.co/api/classes/"+userClass+"/levels/"+level)
            .then(response => response.json())
            .then(responseJson => {
                var spells = responseJson.spellcasting;
                var features = responseJson.features;
                var class_specifics = responseJson.class_specific;  
                var ability_bonus = responseJson.ability_score_bonuses;
                var prof_bonus = responseJson.prof_bonus;

                character.ability_bonus = ability_bonus;
                character.prof_bonus = prof_bonus;
                character.feats = [];
                character.spellSlots = [];

                var ab = document.getElementById("abilityBonus")
                ab.innerHTML= "Your ability scores (INT, DEX, etc) get a bonus of +"+ability_bonus;

                var pb = document.getElementById("scoreBonus")
                pb.innerHTML= "Skills you are proficient in get a bonus of +"+prof_bonus;

                var fts = document.getElementById("feats");
                fts.innerHTML="";
                fts.innerHTML+= "<b>You have the following features (consult a 5e manual for more info): <br><br>";
                if(features.length>0)
                {
                    for (let index = 0; index < features.length; index++) {
                    fts.innerHTML+=features[index].name+"<br>";
                    character.feats.push(features[index].name);
                }
                }


                var sp = document.getElementById("spells");
                sp.innerHTML="";
                if(spells!=undefined){
                    sp.innerHTML= "<b>You have the following spell slots (plus those added by your spellcasting modifier):<br>";
                    var spellLevels=[];
                    var spellLists = [];
                    var spellno = 0;
                for (let index = 0; index < Object.values(spells).length; index++) {
                    if(Object.values(spells)[index]!=0)
                    {
                        sp.innerHTML+= "<br>Level "+index + ": "+Object.values(spells)[index];
                        character.spellSlots.push(Object.values(spells)[index]);
                        spellLevels.push(index);
                        spellno+=parseInt(Object.values(spells)[index]);
                    }
                }
                
                // sa = document.getElementById("spellAmount");
                // sa.innerHTML= "<b>You may choose up to "+spellno+" spells, in the proportion specified to the left <br>";

                var selectSpells = document.getElementById("selectSpells");
                selectSpells.innerHTML = "<b>You may choose up to "+spellno+" spells, in the proportion specified to the left <br><br>";

                for (const key in spellLevels) {
                        spellLists = getSpellsByLevel(userClass,key);
                        spellLists.then((a) => {
                            spellNames=[];
                            for (const name in a) {
                                spellNames.push(a[name].name);
                                    
                            }
                            if(document.getElementById("level"+key)==null)
                            {
                                var div = document.createElement('div');
                                div.id = 'level'+key;
                                div.innerHTML= "Level "+key+"<br>";
                            }
                            else{
                                var div = document.getElementById("level"+key);
                                div.innerHTML= "Level "+key+"<br>";
                                
                            }
                                

                            for (let index = 0; index < spellNames.length; index++) {
                                var checkbox = document.createElement('input');
                                checkbox.type = "checkbox";
                                checkbox.value = 1;
                                checkbox.name = spellNames[index];
                                div.appendChild(checkbox);
                                div.appendChild(document.createTextNode(spellNames[index]));
                                div.innerHTML += "<br>"
                            }
                            div.innerHTML += "<br>"
                            selectSpells.append(div);
                        });
                        
                    }
                
                    

            }
                var cs = document.getElementById("classSpecs");
                cs.innerHTML="";
                cs.innerHTML="<b>Any other class variables or restrictions (i.e Wild Shape's restrictions) are shown here:<br>"
                for (let index = 0; index < Object.values(class_specifics).length; index++) {
                    if(Object.values(class_specifics)[index]!=0 || Object.values(class_specifics)[index]!="[]" )
                    {
                        cs.innerHTML+="<br>"+Object.keys(class_specifics)[index]+": "+Object.values(class_specifics)[index]
                    }
                    
                }

            })
            .catch(error => {
                console.error(error);
            });
        }
     }

     function onSpellSelect(node)
     {
        var checked;
        var checkedLevels = [];
        var spellList = [];
        var selects= node.querySelectorAll("#selectSpells > div");
        for (let index = 0; index < selects.length; index++) { 
            checked = 0;
            var levelSelects = selects[index].querySelectorAll("input");
            for (let index = 0; index < levelSelects.length; index++) {
                if(levelSelects[index].checked)
                {
                checked++;
                spellList.push(levelSelects[index].name);
                }
                
            }
            if(checked>=character.spellSlots[index])
            {
                for (let index = 0; index < levelSelects.length; index++) {
                    if(!levelSelects[index].checked)
                    {
                        levelSelects[index].disabled=true;
                    }
                    
                }
            }
            else
            {
                for (let index = 0; index < levelSelects.length; index++) {
                    levelSelects[index].disabled=false;
                        
                    }
            }
            
        }
        character.spells = spellList;

     }

    function preSubmit()
    {
        skills = [];
        skills.push(class_profs)
        skills.push(race_profs)
        character.proficiencies = skills;
        fetch("/characterInsert", {
            headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
            },
            method: "POST",
            successRedirect : '/', 
            body: JSON.stringify(character)
            });
    }

     function onSkillSelect(checked,node)
     {
        skills = [];
        var selects= node.querySelectorAll("#selectSkills > input");
        for (let index = 0; index < selects.length; index++) {
            if(selects[index].checked)
            {
                checked++;
                skills.push(selects[index].name);
            }
            
        }
        if(checked>=character.proficiencies.amount)
            {
                for (let index = 0; index < selects.length; index++) {
                    if(!selects[index].checked)
                    {
                        selects[index].disabled=true;
                    }
                    
                }
            }
        else
        {
            for (let index = 0; index < selects.length; index++) {
                        selects[index].disabled=false;
                    
                }
        }

     }

     function pointBuySetup()
     {
         var selects= document.querySelectorAll("#selectScores > select");
         points=[]
            for (let index = 8; index < 19; index++) {
                points.push(index);
                
            }
         for (let index = 0; index < selects.length; index++) {
             addToSelect(points,selects[index].id);
             character.abilityScores.push(selects[index].value);
         }
     }

     function pointBuy()
     {
         var selects= document.querySelectorAll("#selectScores > select");
         points=27;
         basePoints=48;
         currPoints=0;

         for (let index = 0; index < selects.length; index++) {
             currPoints+=parseInt(selects[index].value);
             character.abilityScores[index] = selects[index].value;
         }
         var explainerText= document.querySelector("#selectScores > div");
         var calc = (basePoints+points-currPoints);
         explainerText.innerHTML= "Select your Ability Scores! Remaining Points:"+calc+"/27";

         var btn = document.getElementById("formsubmit");
         if(calc<0)
         {
             btn.disabled = true;
         }
         else {
             btn.disabled= false;
         }
     }

     function getSpellsByLevel(userClass,level) {
        return fetch("https://www.dnd5eapi.co/api/classes/"+userClass+"/spells/")
            .then(response => response.json())
            .then(function(responseJson) {
                var classpells = responseJson.results;
                return fetch("https://www.dnd5eapi.co/api/spells?level="+level)
                .then(lvlresponse => lvlresponse.json())
                .then(lvlresponse => {
                    var lvlspells = lvlresponse.results;
                    var innerjoin = [];
                    for (let i = 0; i < classpells.length; i++) {

                        for (let j = 0; j < lvlspells.length; j++) {
                            const element = lvlspells[j].name;

                            if(classpells[i].name== element)
                        {
                            innerjoin.push(classpells[i]);
                        }

                        }
                        
                        
                    }
                    return innerjoin;
                })
            })
            .catch(error => {
                console.error(error);
            });
    }
</script>
